(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[279],{5082:(e,s,t)=>{Promise.resolve().then(t.bind(t,9301))},9301:(e,s,t)=>{"use strict";t.r(s),t.d(s,{default:()=>c});var a=t(5155),l=t(2115),r=t(7319),n=t(2302),i=t(6874),o=t.n(i);async function d(e){let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5,t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:300;for(let a=0;a<s;a++){let s=await (0,n.Re)(e);if(console.log("Retry ".concat(a+1,": fetched address list:"),s),Array.isArray(s)&&s.length>0){let e=[...s].sort((e,s)=>(s.id||0)-(e.id||0));console.log("Sorted address list:",e);let t=e[0].id||e[0].address_id;return console.log("Selected address_id:",t),t}await new Promise(e=>setTimeout(e,t))}return null}function c(){let{state:e,clearCart:s}=(0,r._)(),[t,i]=(0,l.useState)(1),[c,m]=(0,l.useState)({name:"",phone:"",email:"",country:"Kuwait",city:"",postal:"",address:"",addressType:"دائم"}),[u,h]=(0,l.useState)(""),[x,p]=(0,l.useState)(0),[g,y]=(0,l.useState)([]),[b,f]=(0,l.useState)(!1),[j,v]=(0,l.useState)(""),[w,N]=(0,l.useState)(!1),[k,_]=(0,l.useState)(null),[E,S]=(0,l.useState)(null),[B,D]=(0,l.useState)(null),[C,G]=(0,l.useState)([]),[U,q]=(0,l.useState)(!0),[P,T]=(0,l.useState)(null),[A,O]=(0,l.useState)(null),[R,L]=(0,l.useState)(!0),[M,F]=(0,l.useState)(null),[$,W]=(0,l.useState)(null),[z,H]=(0,l.useState)(!1),[X,I]=(0,l.useState)([]),[J,K]=(0,l.useState)(!0),[Y,Q]=(0,l.useState)(null),[V,Z]=(0,l.useState)(null);(0,l.useEffect)(()=>{(0,n.zj)().then(e=>{D(e)}).catch(()=>D(null))},[]),(0,l.useEffect)(()=>{(0,n.P)().then(e=>{O(e),L(!1)}).catch(()=>{F("تعذر الحصول على رقم الضيف. يرجى إعادة تحميل الصفحة."),L(!1)})},[]),(0,l.useEffect)(()=>{if(!R&&A){let{sellerId:s,sellerType:t}=(0,n.Yg)(e.items);f(!0),(0,n.vp)(s,t,A).then(e=>{console.log("Fetched shipping options:",e),y(e),e.length>0&&(h(e[0].key||e[0].id||e[0].title),p(Number(e[0].cost||0)))}).catch(e=>{y([])}).finally(()=>f(!1))}},[R,A,e.items]),(0,l.useEffect)(()=>{A&&(K(!0),fetch("https://awisapp.com/api/v1/customer/get-restricted-country-list?guest_id=".concat(A)).then(async e=>{if(!e.ok){let s="تعذر تحميل قائمة الدول. يرجى إعادة المحاولة لاحقاً.";401===e.status&&(s="غير مصرح. يرجى إعادة تحميل الصفحة أو تسجيل الدخول."),I([]),Q(s),K(!1);return}let s=await e.json();Array.isArray(s)&&s.length>0&&s.every(e=>"string"==typeof e)?(I(s),Q(null)):(I([]),Q("تعذر تحميل قائمة الدول. يرجى إعادة المحاولة لاحقاً.")),K(!1)}).catch(()=>{I([]),Q("تعذر تحميل قائمة الدول. يرجى التحقق من الاتصال أو المحاولة لاحقاً."),K(!1)}))},[A]),(0,l.useEffect)(()=>{!async function(){q(!0),T(null);try{let e=await fetch("https://awisapp.com/api/v1/config");if(!e.ok)throw Error("فشل تحميل طرق الدفع من الخادم");let s=(await e.json()).payment_methods||[];console.log("[DEBUG] paymentMethods:",s),G(s),(!j||""===j)&&s.length>0&&v(s[0].key||s[0].key_name||"")}catch(e){T(e.message||"فشل تحميل طرق الدفع")}finally{q(!1)}}()},[]),(0,l.useEffect)(()=>{V&&(console.log("[DEBUG] pendingRedirect triggered:",V),window.location.href=V)},[V]);let ee=()=>1===t?["name","phone","email","country","city","postal","address"].every(e=>""!==c[e].trim()):2===t?!!u:3!==t||!!j,es=async()=>{_(null);try{if(!ee())throw Error("يرجى تعبئة جميع الحقون المطلوبة");i(2)}catch(e){_(e.message||"حدث خطأ أثناء إضافة العنوان")}},et=async()=>{try{var t;if(N(!0),_(null),S(null),console.log("[DEBUG] handlePayment called",{delivery:u,payment:j,guestId:A,guestIdLoading:R,items:e.items}),!u)throw Error("يرجى اختيار طريقة التوصيل");if(!j)throw Error("يرجى اختيار طريقة الدفع");if(!e.items.length)throw Error("السلة فارغة");if(R||!A)throw Error("يرجى الانتظار حتى يتم تجهيز الحساب المؤقت");let a=await (0,n.E1)({name:c.name,phone:c.phone,email:c.email,country:c.country,city:c.city,postal:c.postal,address:c.address,address_type:c.addressType,guest_id:A}),l=a.address_id||a.id||(null==(t=a.data)?void 0:t.id);if(l||(l=await d(A)),console.log("[DEBUG] Got address_id:",l),!l)throw Error("فشل حفظ العنوان. يرجى المحاولة مرة أخرى.");let r=await (0,n.Xl)();if(console.log("[DEBUG] Cart before shipping selection (order):",r),!Array.isArray(r)||0===r.length){_("السلة فارغة أو لم يتم مزامنتها مع الخادم بعد. يرجى إضافة منتجات وإعادة المحاولة."),N(!1);return}let o="default";if(r[0].cart_group_id&&(o=r[0].cart_group_id),console.log("[DEBUG] Using cart_group_id for shipping (order):",o),await (0,n.Pg)(u,A,o),console.log("[DEBUG] Shipping method chosen (order):",u,"cart_group_id:",o),"cod"!==j){let e={order_note:"",customer_id:A,address_id:l,billing_address_id:l,coupon_code:"",coupon_discount:"",payment_method:j,is_check_create_account:!1,password:"",payment_platform:"web",payment_request_from:"app",guest_id:A,is_guest:!0,external_redirect_link:"https://awisapp.com/web-payment?flag=success&&token={token}"};console.log("[DEBUG] Digital payment payload:",e);let s=await fetch("https://awisapp.com/api/v1/digital-payment",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e),credentials:"include"});if(console.log("[DEBUG] Response status:",s.status),!s.ok){let e=await s.text();throw console.error("[DEBUG] Backend error response:",e),Error("Backend error: ".concat(s.status," ").concat(s.statusText))}if(s.redirected){console.log("[DEBUG] Response was redirected to:",s.url),window.location.href=s.url;return}let t=await s.json();if(console.log("[DEBUG] Digital payment response:",t),t&&t.redirect_link)console.log("[DEBUG] Redirecting to payment gateway:",t.redirect_link),window.location.href=t.redirect_link;else{let e=t&&"object"==typeof t&&"message"in t?t.message:String(t);throw Error("No redirect_link received from backend! Error: "+e)}return}let m={address_id:l,delivery:u,payment:j,order_note:"",cartItems:e.items.map(e=>({product_id:e.product_id,quantity:e.quantity,variant:e.variant,color:e.color||void 0})),guest_id:A,country:c.country,city:c.city,postal:c.postal,phone:c.phone,name:c.name,address:c.address,email:c.email,shipping_cost:x};console.log("[DEBUG] placeOrder payload:",m);let h=await (0,n.wH)(m);console.log("[DEBUG] placeOrder response:",h),S("تم إرسال الطلب بنجاح!"),s(),i(4)}catch(e){e&&e.message?(_(e.message),console.error("[DEBUG] handlePayment error:",e.message)):(_("حدث خطأ أثناء الشراء"),console.error("[DEBUG] handlePayment error: unknown"))}finally{N(!1)}};return R||!A?(0,a.jsx)("div",{className:"text-center text-lg py-10",children:"جاري تجهيز الحساب المؤقت للزائر..."}):M?(0,a.jsx)("div",{className:"min-h-screen flex items-center justify-center bg-red-100",children:(0,a.jsx)("div",{className:"text-red-600 text-lg",children:M})}):(0,a.jsxs)("div",{className:"min-h-screen bg-gray-50",dir:"rtl",children:[(0,a.jsx)("header",{className:"bg-white shadow-sm",children:(0,a.jsx)("div",{className:"max-w-2xl mx-auto px-4",children:(0,a.jsxs)("div",{className:"relative flex items-center py-2 border-b border-gray-100 min-h-[48px]",children:[1===t?(0,a.jsx)(o(),{href:"/cart","aria-label":"Back to cart",className:"absolute left-0 top-1/2 -translate-y-1/2 inline-flex items-center justify-center w-9 h-9 rounded-full bg-gray-100 hover:bg-gray-200 transition-colors shadow-sm focus:outline-none focus:ring-2 focus:ring-[#991b1b]",children:(0,a.jsx)("svg",{className:"w-5 h-5 text-[#991b1b]",fill:"none",stroke:"currentColor",strokeWidth:"2",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M15 19l-7-7 7-7"})})}):(0,a.jsx)("button",{type:"button",onClick:()=>i(1),"aria-label":"Back to address",className:"absolute left-0 top-1/2 -translate-y-1/2 inline-flex items-center justify-center w-9 h-9 rounded-full bg-gray-100 hover:bg-gray-200 transition-colors shadow-sm focus:outline-none focus:ring-2 focus:ring-[#991b1b]",children:(0,a.jsx)("svg",{className:"w-5 h-5 text-[#991b1b]",fill:"none",stroke:"currentColor",strokeWidth:"2",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M15 19l-7-7 7-7"})})}),(0,a.jsx)("h1",{className:"mx-auto text-xl font-bold text-gray-900 truncate max-w-xs md:max-w-lg text-center w-full",children:"الدفع"})]})})}),(0,a.jsxs)("main",{className:"max-w-2xl mx-auto px-4 py-8",children:[(0,a.jsx)(()=>(0,a.jsx)("div",{className:"flex justify-center gap-2 mb-8",children:[1,2].map(e=>(0,a.jsx)("div",{className:"w-8 h-2 rounded-full transition-all duration-300 ".concat(t===e?"bg-blue-600 w-16":t>e?"bg-green-500":"bg-gray-300")},e))}),{}),1===t&&(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow p-6 mb-6",children:[(0,a.jsx)("h2",{className:"text-xl font-semibold mb-4",children:"معلومات العنوان"}),(0,a.jsxs)("form",{className:"space-y-4",onSubmit:e=>{e.preventDefault(),es()},children:[(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsxs)("label",{className:"block mb-1 font-medium",children:["اسم الشخص المسؤول ",(0,a.jsx)("span",{className:"text-red-500",children:"*"})]}),(0,a.jsx)("input",{name:"name",value:c.name,onChange:e=>m({...c,name:e.target.value}),className:"w-full border rounded p-2",required:!0})]}),(0,a.jsxs)("div",{children:[(0,a.jsxs)("label",{className:"block mb-1 font-medium",children:["هاتف ",(0,a.jsx)("span",{className:"text-red-500",children:"*"})]}),(0,a.jsx)("input",{name:"phone",value:c.phone,onChange:e=>m({...c,phone:e.target.value}),className:"w-full border rounded p-2",required:!0})]}),(0,a.jsxs)("div",{children:[(0,a.jsxs)("label",{className:"block mb-1 font-medium",children:["بريد إلكتروني ",(0,a.jsx)("span",{className:"text-red-500",children:"*"})]}),(0,a.jsx)("input",{name:"email",value:c.email,onChange:e=>m({...c,email:e.target.value}),className:"w-full border rounded p-2",required:!0})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block mb-1 font-medium",children:"نوع العنوان"}),(0,a.jsxs)("select",{name:"addressType",value:c.addressType,onChange:e=>m({...c,addressType:e.target.value}),className:"w-full border rounded p-2",children:[(0,a.jsx)("option",{value:"دائم",children:"دائم"}),(0,a.jsx)("option",{value:"مؤقت",children:"مؤقت"})]})]}),(0,a.jsxs)("div",{className:"mb-4",children:[(0,a.jsx)("label",{className:"block mb-1",children:"الدولة"}),J?(0,a.jsx)("div",{children:"جاري تحميل قائمة الدول..."}):0===X.length?(0,a.jsx)("div",{className:"text-red-500",children:Y||"تعذر تحميل قائمة الدول."}):(0,a.jsxs)("select",{className:"input",value:c.country,onChange:e=>m({...c,country:e.target.value}),required:!0,children:[(0,a.jsx)("option",{value:"",children:"اختر الدولة"}),X.map(e=>(0,a.jsx)("option",{value:e,children:e},e))]}),Y&&X.length>0&&(0,a.jsx)("div",{className:"text-red-500 text-sm mt-1",children:Y})]}),(0,a.jsxs)("div",{children:[(0,a.jsxs)("label",{className:"block mb-1 font-medium",children:["مدينة ",(0,a.jsx)("span",{className:"text-red-500",children:"*"})]}),(0,a.jsx)("input",{name:"city",value:c.city,onChange:e=>m({...c,city:e.target.value}),className:"w-full border rounded p-2",required:!0})]}),(0,a.jsxs)("div",{children:[(0,a.jsxs)("label",{className:"block mb-1 font-medium",children:["الرمز البريدي ",(0,a.jsx)("span",{className:"text-red-500",children:"*"})]}),(0,a.jsx)("input",{name:"postal",value:c.postal,onChange:e=>m({...c,postal:e.target.value}),className:"w-full border rounded p-2",required:!0})]}),(0,a.jsxs)("div",{className:"md:col-span-2",children:[(0,a.jsxs)("label",{className:"block mb-1 font-medium",children:["عنوان ",(0,a.jsx)("span",{className:"text-red-500",children:"*"})]}),(0,a.jsx)("input",{name:"address",value:c.address,onChange:e=>m({...c,address:e.target.value}),className:"w-full border rounded p-2",required:!0})]})]}),k&&(0,a.jsx)("div",{className:"text-red-600 text-center mt-2",children:k}),(0,a.jsx)("button",{type:"submit",className:"w-full bg-blue-600 text-white py-3 px-4 rounded-md hover:bg-blue-700 transition-colors mt-4",disabled:z,children:z?"...جاري حفظ العنوان":"التالي"})]})]}),2===t&&(0,a.jsxs)("form",{onSubmit:e=>{e.preventDefault(),et()},children:[(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow p-6 mb-6",children:[(0,a.jsx)("h2",{className:"text-xl font-semibold mb-4",children:"طريقة الشحن"}),b?(0,a.jsx)("div",{className:"text-center text-gray-500",children:"جاري تحميل خيارات الشحن..."}):0===g.length?(0,a.jsx)("div",{className:"text-center text-red-500",children:"لا توجد خيارات شحن متاحة حالياً لهذا البائع. جرب تحديث الصفحة أو التواصل مع الدعم."}):(0,a.jsx)("div",{className:"flex flex-col gap-4 mt-2",children:g.map((e,s)=>(0,a.jsxs)("label",{className:"flex items-center gap-2 cursor-pointer",children:[(0,a.jsx)("input",{type:"radio",name:"delivery",value:e.key||e.id||e.title,checked:u===(e.key||e.id||e.title),onChange:async()=>{h(e.key||e.id||e.title),p(Number(e.cost||0));try{if(A){let s=await (0,n.Xl)();if(!Array.isArray(s)||0===s.length)return void _("السلة فارغة أو لم يتم مزامنتها مع الخادم بعد. يرجى إضافة منتجات وإعادة المحاولة.");let t="default";s[0].cart_group_id&&(t=s[0].cart_group_id),await (0,n.Pg)(e.id,A,t)}}catch(e){_("تعذر حفظ طريقة الشحن المختارة. يرجى المحاولة مرة أخرى.")}}}),(0,a.jsx)("span",{children:e.title||e.name}),(0,a.jsx)("span",{className:"text-sm text-gray-500",children:e.duration?"مدة التوصيل: ".concat(e.duration," أيام"):""}),(0,a.jsx)("span",{className:"ml-2 font-bold",children:void 0!==e.cost?"".concat(e.cost," د.ك"):""})]},e.id||e.key||s))})]}),(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow p-6 mb-6",children:[(0,a.jsx)("h2",{className:"text-xl font-semibold mb-4",children:"طريقة الدفع"}),U?(0,a.jsx)("div",{children:"جاري تحميل طرق الدفع..."}):P?(0,a.jsx)("div",{style:{color:"red"},children:P}):(0,a.jsx)("div",{className:"flex gap-4 mt-2 flex-wrap items-center",children:C.map((e,s)=>{var t;return(0,a.jsx)("label",{className:"flex-1 border rounded p-3 cursor-pointer min-w-[120px] ".concat(j===(e.key||e.key_name)?"border-blue-600 bg-blue-50":"border-gray-200"," flex items-center gap-2"),children:(null==(t=e.key||e.key_name)?void 0:t.toLowerCase())==="fatoorah"?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("input",{type:"radio",name:"payment",value:e.key||e.key_name,checked:j===(e.key||e.key_name),onChange:()=>v(e.key||e.key_name),className:"ml-2 order-1",disabled:U}),(0,a.jsx)("div",{className:"flex-1 flex justify-center order-2",children:(0,a.jsx)("img",{src:"/payment-logos.png",alt:"Fatoorah Payment Methods",className:"h-10 max-w-[180px] object-contain"})})]}):(0,a.jsxs)(a.Fragment,{children:[e.image&&(0,a.jsx)("img",{src:e.image,alt:e.name||e.label||"طريقة الدفع",className:"h-5 inline"}),e.name||e.label||e.key||e.key_name]})},e.key||e.name||s)})})]}),(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow p-6 mb-6",children:[(0,a.jsx)("h2",{className:"text-lg font-semibold mb-4",children:"ملخص الطلب"}),0===e.items.length?(0,a.jsx)("div",{className:"text-gray-500",children:"السلة فارغة"}):(0,a.jsx)("ul",{className:"divide-y divide-gray-200 mb-4",children:e.items.map(e=>(0,a.jsxs)("li",{className:"py-2 flex justify-between items-center",children:[(0,a.jsxs)("span",{className:"text-sm",children:[e.name," \xd7 ",e.quantity]}),(0,a.jsx)("span",{className:"text-sm font-medium",children:(0,n.$g)((e.price-e.discount)*e.quantity,B)})]},e.id))}),(0,a.jsxs)("div",{className:"flex justify-between text-sm mb-1",children:[(0,a.jsx)("span",{children:"المجموع الفرعي"}),(0,a.jsx)("span",{children:(0,n.$g)(e.subtotal,B)})]}),(0,a.jsxs)("div",{className:"flex justify-between text-sm mb-1",children:[(0,a.jsx)("span",{children:"شحن"}),(0,a.jsx)("span",{children:(0,n.$g)(x,B)})]}),(0,a.jsxs)("div",{className:"border-t pt-3 flex justify-between text-lg font-semibold",children:[(0,a.jsx)("span",{children:"المجموع"}),(0,a.jsx)("span",{children:(0,n.$g)(e.subtotal+x,B)})]})]}),k&&(0,a.jsxs)("div",{className:"text-red-600 text-center mt-4 text-lg font-bold",children:["[خطأ]: ",k]}),(0,a.jsx)("button",{type:"submit",className:"w-full bg-blue-600 text-white py-3 px-4 rounded-md hover:bg-blue-700 transition-colors text-lg font-bold mt-4",disabled:w||!j||U||b||!u,children:w?(0,a.jsx)("span",{className:"flex items-center justify-center",children:(0,a.jsxs)("svg",{className:"animate-spin h-6 w-6 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[(0,a.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,a.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"})]})}):"cod"!==j?"ادفع الآن":"تأكيد الطلب"})]}),4===t&&(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow p-6 mb-6 text-center",children:[(0,a.jsx)("h2",{className:"text-2xl font-bold text-green-600 mb-4",children:"تم إرسال الطلب بنجاح!"}),(0,a.jsx)("p",{className:"mb-6",children:"شكراً لطلبك. سيتم التواصل معك قريباً."}),(0,a.jsx)(o(),{href:"/",className:"bg-blue-600 text-white py-2 px-6 rounded",children:"العودة للرئيسية"})]})]}),(0,a.jsx)("div",{className:"h-20 md:hidden"})]})}}},e=>{var s=s=>e(e.s=s);e.O(0,[874,319,441,684,358],()=>s(5082)),_N_E=e.O()}]);